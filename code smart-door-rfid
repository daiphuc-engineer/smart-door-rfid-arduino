#include <Servo.h>
#include <SPI.h>
#include <MFRC522.h>
// =======================
// khai báo servo
// =======================
Servo myServo;


// =======================
// RFID setup
// =======================
#define ss_pin 10
#define rst_pin 9
MFRC522 mfrc522(ss_pin, rst_pin);


// =======================
// Door Lock setup
// ======================

#define BUZZER 4
#define LED_GREEN 6
#define LED_RED 7

// =======================
byte allowedUID[4] = {0x17, 0xCF, 0x6A, 0x05};// khai báo uid cửa

// =======================
void setup() {
  Serial.begin(115200);
  SPI.begin();
  pinMode(BUZZER, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);
  pinMode(LED_RED, OUTPUT);
  myServo.attach(5);
  myServo.write(0);

  mfrc522.PCD_Init();
  delay(1500);
}

// =======================
void loop() {

  if (!mfrc522.PICC_IsNewCardPresent()) return;
  if (!mfrc522.PICC_ReadCardSerial()) return;
  mfrc522.PICC_DumpToSerial(&(mfrc522.uid));

  bool access = checkUID();

  if (access) {
    openDoor();
  } else {
    denyAccess();
  }

  delay(1500);
}

// =======================
// Kiểm tra UID thẻ
// =======================
bool checkUID() {
  for (byte i = 0; i < 4; i++) {
    if (mfrc522.uid.uidByte[i] != allowedUID[i]) {
      return false;
    }
  }
  return true;
}

// =======================
// Mở cửa
// =======================
void openDoor() {
  digitalWrite(LED_GREEN, HIGH);
  tone(BUZZER, 2000, 150);

  myServo.write(90);
  delay(3000);

  myServo.write(0);
  delay(500);

  delay(3000);

  digitalWrite(LED_GREEN, LOW);
}

// =======================
// Từ chối
// =======================
void denyAccess() {
  digitalWrite(LED_RED, HIGH);
  tone(BUZZER, 300, 300);
  myServo.write(0);

  delay(1500);
  digitalWrite(LED_RED, LOW);
}
